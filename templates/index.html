<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Map Area Calculator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <link rel="stylesheet" href="../static/index.css">
</head>

<body>
<h2>Map Based Area Measurement and Address Detection Web Application</h2>
<h3>Draw Area on Map</h3>

<div class="map-container">
    <div id="map"></div>
</div>

<div class="result">
    <p id="address"><b>Address:</b>-</p>
    <p id="area"><b>Area:</b>-</p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
    const map = L.map('map').setView([37.0902, -95.7129], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup().addTo(map);

    map.addControl(new L.Control.Draw({
        draw: { polygon: true, marker: false, polyline: false, circle: false, rectangle: false },
        edit: { featureGroup: drawnItems }
    }));

    map.on(L.Draw.Event.CREATED, async (e) => {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);

        setUI("Fetching address...", "Calculating area...");

        const coords = e.layer.getLatLngs()[0].map(p => [p.lat, p.lng]);

        try {
            const res = await fetch("/calculate-area", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ coordinates: coords })
            });

            const data = await res.json();
            setUI(data.address, `${data.area_square_meters} m² (${data.area_square_feet} ft²)`);
        } catch {
            setUI("Error fetching address", "Error calculating area");
        }
    });

    function setUI(address, area) {
        document.getElementById("address").innerHTML = `<b>Address:</b> ${address}`;
        document.getElementById("area").innerHTML = `<b>Area:</b> ${area}`;
    }
</script>

</body>
</html>
